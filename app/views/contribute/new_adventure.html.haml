%article.bodyText  %h1 New Adventure  = form_for @adventure, :url => new_adventure_path do |f|    .collapse_group{:"data-name" => "Adventure fields"}= render :partial => 'adventure_form', :locals => {:f => f}    .row      #submitBtn= f.submit 'Next - Define Encounter Types', :class => "btn offset2"        :markdown    $.previewXhr = 0;    // Grab the nested fields for any encounters already on the adventure    $('<div/>')      .insertBefore($('#submitBtn').parent())      .load('#{enc_fields_for_adv_path} #encFields', function(data){        $('#encFields')          .unwrap()          .replaceWith($('#encFields').html());                  updatePage();           });             function updatePage()    {      // Wrap the sections of form in a collapser block      $('.collapse_group').collapser();          // Remove, hide or relabel sections of the Adventure form that we no longer need      $('.numEncounters').hide();      $('#submitBtn input.btn').val("Submit Adventure");            // Any existing Encounter or Resolution forms get a "Remove this " button      // Because of the collapser, each such can be found as having a .collapse_group[data_name="Resolution fields"],       // and we wish to remove the parent .group      $('.collapse_group[data-name="Resolution fields"]').remover();      $('.collapse_group[data-name="Encounter fields"]').remover();              // Create a button to add a new Encounter section      var addButton = $('<input type="button" class="btn success offset2 input" value="Add Encounter"/>');      var encFields;      $.get('#{new_enc_fields_for_adv_path}', function(data) {        encFields = $(data).find('#encFields').html();        addButton          .insertBefore($('#submitBtn').parent())          .wrap('<div class="row"/>')          .click( function(e) {            e.preventDefault();            e.stopPropagation();            $(encFields)              .insertBefore($(this).closest('.row'))              .hide()              .collapser()              .remover()              .animate({height: 'toggle'});          })      });            // Create a fixed footer to hold a preview      $('<div class="row"><div id="preview" class="span16"/></div>').appendTo($('.container'));           advPreview();    };              function advPreview() {                  $.ajax('#{adventure_preview_path}', {       type: 'post',        data: $('#new_adventure_file').serialize(),               beforeSend: function(xhr) {          if ($.previewXhr != 0)            $.previewXhr.abort();                      $.previewXhr = xhr;          },          success: function(data, textStatus) {         $('#preview').html("Your adventure will look like this: " + data);                    // Pad the main form so the preview won't prevent the buttons being pressed.          $('.container').css({paddingBottom: $('#preview').height() + 18 + "px"});        }      })    };        // When the user updates part of the form, generate a preview          $('#new_adventure_file').delegate('input,textarea,select', 'blur', advPreview);